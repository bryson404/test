-- ============================================
-- KIRITO SOFTWORKS NFS CLIENT v5.1
-- Network File System Client with Storage Display
-- ============================================

local SERVER_ID = nil
local MODEM_SIDE = nil
local MOUNT_POINT = "/net"
local CURRENT_STATS = nil

-- ============================================
-- MODEM SETUP
-- ============================================

function openModem()
    local sides = {"top", "bottom", "left", "right", "front", "back"}
    for _, side in ipairs(sides) do
        if peripheral.getType(side) == "modem" then
            MODEM_SIDE = side
            rednet.open(side)
            return true
        end
    end
    for _, name in ipairs(peripheral.getNames()) do
        if peripheral.getType(name) == "modem" then
            MODEM_SIDE = name
            rednet.open(name)
            return true
        end
    end
    return false
end

function findServer()
    print("Searching for NFS server...")
    rednet.broadcast({ action = "discover" }, "jbod")
    
    local timer = os.startTimer(3)
    while true do
        local event, id, msg, protocol = os.pullEvent()
        if event == "rednet_message" and protocol == "jbod" and msg and msg.server then
            print("Found server at computer " .. id)
            SERVER_ID = id
            return true
        elseif event == "timer" and id == timer then
            return false
        end
    end
end

function connect(serverId)
    SERVER_ID = serverId
    return true
end

-- ============================================
-- NFS OPERATIONS
-- ============================================

function nfsList()
    if not SERVER_ID then return nil end
    rednet.send(SERVER_ID, { action = "list" }, "jbod")
    
    local timer = os.startTimer(5)
    while true do
        local event, id, msg = os.pullEvent()
        if event == "rednet_message" and id == SERVER_ID then
            return msg.files or {}
        elseif event == "timer" and id == timer then
            return nil
        end
    end
end

function nfsRead(filename)
    if not SERVER_ID then return nil end
    rednet.send(SERVER_ID, { action = "read", file = filename }, "jbod")
    
    local timer = os.startTimer(5)
    while true do
        local event, id, msg = os.pullEvent()
        if event == "rednet_message" and id == SERVER_ID then
            return msg.data
        elseif event == "timer" and id == timer then
            return nil
        end
    end
end

function nfsWrite(filename, data)
    if not SERVER_ID then return false end
    rednet.send(SERVER_ID, { action = "write", file = filename, data = data }, "jbod")
    
    local timer = os.startTimer(5)
    while true do
        local event, id, msg = os.pullEvent()
        if event == "rednet_message" and id == SERVER_ID then
            return msg.success
        elseif event == "timer" and id == timer then
            return false
        end
    end
end

function nfsDelete(filename)
    if not SERVER_ID then return false end
    rednet.send(SERVER_ID, { action = "delete", file = filename }, "jbod")
    
    local timer = os.startTimer(3)
    while true do
        local event, id, msg = os.pullEvent()
        if event == "rednet_message" and id == SERVER_ID then
            return msg.success
        elseif event == "timer" and id == timer then
            return false
        end
    end
end

function nfsStats()
    if not SERVER_ID then return nil end
    rednet.send(SERVER_ID, { action = "stats" }, "jbod")
    
    local timer = os.startTimer(3)
    while true do
        local event, id, msg = os.pullEvent()
        if event == "rednet_message" and id == SERVER_ID then
            return msg.stats
        elseif event == "timer" and id == timer then
            return nil
        end
    end
end

function nfsExecute(filename, ...)
    if not SERVER_ID then 
        print("Not connected to server!")
        return false 
    end
    
    rednet.send(SERVER_ID, { 
        action = "execute", 
        file = filename,
        args = {...}
    }, "jbod")
    
    local timer = os.startTimer(10)
    while true do
        local event, id, msg = os.pullEvent()
        if event == "rednet_message" and id == SERVER_ID then
            if msg.success and msg.code then
                local func, err = load(msg.code, "=" .. filename, "t", _ENV)
                if not func then
                    print("Error loading: " .. tostring(err))
                    return false
                end
                local ok, result = pcall(func, ...)
                if not ok then
                    print("Runtime error: " .. tostring(result))
                    return false
                end
                return true, result
            else
                print("Server error: " .. tostring(msg.error))
                return false
            end
        elseif event == "timer" and id == timer then
            print("Request timed out")
            return false
        end
    end
end

-- ============================================
-- STORAGE DISPLAY
-- ============================================

function formatBytes(b)
    if b >= 1000000000 then return string.format("%.2f GB", b/1000000000)
    elseif b >= 1000000 then return string.format("%.1f MB", b/1000000)
    elseif b >= 1000 then return string.format("%.1f KB", b/1000)
    else return b .. " B" end
end

function drawBar(percent, width)
    width = width or 10
    local filled = math.floor((percent / 100) * width)
    filled = math.max(0, math.min(filled, width))
    return string.rep("*", filled) .. string.rep("=", width - filled)
end

function updateStats()
    CURRENT_STATS = nfsStats()
end

function displayStorage()
    -- Get fresh stats
    updateStats()
    
    if not CURRENT_STATS then
        print("Storage: Unknown")
        return
    end
    
    local total = CURRENT_STATS.total or 0
    local used = CURRENT_STATS.used or 0
    local percent = CURRENT_STATS.percent or 0
    
    -- Display format: 90MB [*****=====]50% full
    local totalStr = formatBytes(total)
    local bar = drawBar(percent, 10)
    
    print(totalStr)
    print("[" .. bar .. "]" .. percent .. "% full")
    print()
end

-- ============================================
-- INTERACTIVE NFS SHELL
-- ============================================

function nfsShell()
    while true do
        -- Clear screen and redraw everything
        term.clear()
        term.setCursorPos(1, 1)
        
        -- Header
        print("===================================================")
        print("  KIRITO SOFTWORKS NFS CLIENT")
        print("  Server: " .. SERVER_ID)
        print("===================================================")
        print()
        
        -- Storage display (updated each loop)
        displayStorage()
        
        -- Commands help
        print("Commands:")
        print("  ls, dir          - List remote files")
        print("  cat <file>       - View remote file")
        print("  edit <file>      - Edit remote file")
        print("  run <file>       - Run remote file directly")
        print("  put <file>       - Upload local file")
        print("  rm <file>        - Delete remote file")
        print("  refresh          - Refresh storage display")
        print("  quit             - Exit")
        print()
        
        -- Get command
        write("nfs> ")
        local input = read()
        local args = {}
        for word in input:gmatch("%S+") do table.insert(args, word) end
        
        local cmd = args[1] or ""
        
        if cmd == "quit" or cmd == "exit" then
            break
            
        elseif cmd == "ls" or cmd == "dir" then
            print()
            local files = nfsList()
            if files then
                print("Remote files:")
                for _, f in ipairs(files) do
                    print("  " .. f)
                end
                print("Total: " .. #files)
            else
                print("Failed to list files")
            end
            print()
            print("Press Enter...")
            read()
            
        elseif cmd == "cat" and args[2] then
            print()
            local data = nfsRead(args[2])
            if data then
                print(data)
            else
                print("File not found")
            end
            print()
            print("Press Enter...")
            read()
            
        elseif cmd == "edit" and args[2] then
            local data = nfsRead(args[2]) or ""
            local tmp = "/.nfs_edit_" .. args[2]
            local h = fs.open(tmp, "w")
            h.write(data)
            h.close()
            
            -- Clear screen for editor
            term.clear()
            term.setCursorPos(1, 1)
            
            shell.run("edit", tmp)
            
            local h2 = fs.open(tmp, "r")
            local newData = h2.readAll()
            h2.close()
            
            if newData ~= data then
                if nfsWrite(args[2], newData) then
                    print()
                    print("Saved to server")
                else
                    print()
                    print("Failed to save")
                end
            end
            fs.delete(tmp)
            print("Press Enter...")
            read()
            
        elseif cmd == "run" and args[2] then
            print()
            local fname = args[2]:gsub("%.lua$", "") .. ".lua"
            nfsExecute(fname, select(3, unpack(args)))
            print()
            print("Press Enter...")
            read()
            
        elseif cmd == "put" and args[2] then
            print()
            local localFile = args[2]
            local remoteName = args[3] or fs.getName(localFile)
            
            if not fs.exists(localFile) then
                print("Local file not found")
            else
                local h = fs.open(localFile, "r")
                local data = h.readAll()
                h.close()
                
                if nfsWrite(remoteName, data) then
                    print("Uploaded: " .. remoteName)
                else
                    print("Upload failed")
                end
            end
            print()
            print("Press Enter...")
            read()
            
        elseif cmd == "rm" and args[2] then
            print()
            if nfsDelete(args[2]) then
                print("Deleted: " .. args[2])
            else
                print("Delete failed")
            end
            print()
            print("Press Enter...")
            read()
            
        elseif cmd == "refresh" then
            -- Just loop back and redraw
            
        elseif cmd ~= "" then
            print()
            if cmd:match("%.lua$") then
                nfsExecute(cmd)
            else
                print("Unknown command: " .. cmd)
            end
            print()
            print("Press Enter...")
            read()
        end
    end
end

-- ============================================
-- MAIN
-- ============================================

function main()
    print("===================================================")
    print("  KIRITO SOFTWORKS NFS CLIENT v5.1")
    print("  Run files directly from server - no download!")
    print("===================================================")
    print()
    
    if not openModem() then
        print("ERROR: No modem found!")
        return
    end
    
    print("1. Auto-discover server")
    print("2. Enter server ID manually")
    write("Choice: ")
    local choice = read()
    
    if choice == "1" then
        if not findServer() then
            print("Server not found!")
            write("Enter ID manually: ")
            local id = tonumber(read())
            if id then connect(id) end
        end
    else
        write("Server ID: ")
        local id = tonumber(read())
        if id then connect(id) end
    end
    
    if not SERVER_ID then
        print("Not connected!")
        return
    end
    
    -- Get initial stats
    updateStats()
    
    -- Start NFS shell
    nfsShell()
    
    print("Goodbye!")
end

main()
