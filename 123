-- ============================================
-- KIRITO SOFTWORKS JBOD NFS SERVER v5.1
-- Complete Network File System Server
-- Supports multiple drives, remote execution, and stats
-- ============================================

local JBOD = {
    version = "5.1",
    drives = {},
    clients = {},
    accessLog = {},
    running = true
}

-- ============================================
-- MODEM SETUP
-- ============================================

function JBOD:openModem()
    local sides = {"top", "bottom", "left", "right", "front", "back"}
    for _, side in ipairs(sides) do
        if peripheral.getType(side) == "modem" then
            rednet.open(side)
            print("Modem opened on " .. side)
            return true
        end
    end
    for _, name in ipairs(peripheral.getNames()) do
        if peripheral.getType(name) == "modem" then
            rednet.open(name)
            print("Modem opened: " .. name)
            return true
        end
    end
    return false
end

-- ============================================
-- DRIVE DETECTION
-- ============================================

JBOD.VALID_TYPES = {
    "drive", "disk_drive", "diskraid", "disk_raid",
    "advanced_disk_raid", "advanceddiskraid",
    "storage", "drive_bay", "media_drive"
}

function JBOD:isValidStorageType(pType)
    if not pType then return false end
    pType = pType:lower()
    for _, v in ipairs(self.VALID_TYPES) do
        if pType:find(v) then return true end
    end
    return false
end

function JBOD:scanDrives()
    self.drives = {}
    print("Scanning for storage devices...")
    
    for _, name in ipairs(peripheral.getNames()) do
        local pType = peripheral.getType(name)
        
        if self:isValidStorageType(pType) then
            local drive = peripheral.wrap(name)
            local isRaid = pType:find("raid") ~= nil
            local hasMedia = isRaid
            
            if not isRaid and drive.isDiskPresent then
                local ok, result = pcall(function() return drive.isDiskPresent() end)
                hasMedia = ok and result
            end
            
            if hasMedia then
                local mountPath = nil
                if drive.getMountPath then
                    local ok, mp = pcall(function() return drive.getMountPath() end)
                    if ok then mountPath = mp end
                end
                if not mountPath then mountPath = name end
                
                local diskId = "N/A"
                if drive.getDiskID then
                    local ok, id = pcall(function() return drive.getDiskID() end)
                    if ok and id then diskId = tostring(id) end
                end
                
                table.insert(self.drives, {
                    name = name,
                    peripheral = drive,
                    pType = pType,
                    mountPath = mountPath,
                    diskId = diskId,
                    fullPath = "/" .. mountPath,
                    isRaid = isRaid
                })
                
                print("  Found: " .. name .. " [" .. pType .. "] -> " .. mountPath)
            end
        end
    end
    
    table.sort(self.drives, function(a,b) return a.name < b.name end)
    print("Total drives: " .. #self.drives)
    return #self.drives
end

-- ============================================
-- FILE OPERATIONS
-- ============================================

function JBOD:getDriveFiles(driveIndex)
    local drive = self.drives[driveIndex]
    local files = {}
    local p = drive.peripheral
    
    if drive.isRaid and p.getDisk then
        for slot = 1, 9 do
            local ok, disk = pcall(function() return p.getDisk(slot) end)
            if ok and disk and disk.getMountPath then
                local ok2, mp = pcall(function() return disk.getMountPath() end)
                if ok2 and mp then
                    local path = "/" .. mp
                    if fs.isDir(path) then
                        for _, fname in ipairs(fs.list(path)) do
                            local fpath = path .. "/" .. fname
                            if not fs.isDir(fpath) then
                                table.insert(files, {
                                    name = fname,
                                    size = fs.getSize(fpath),
                                    drive = driveIndex,
                                    slot = slot,
                                    path = fpath
                                })
                            end
                        end
                    end
                end
            end
        end
    elseif drive.fullPath and fs.isDir(drive.fullPath) then
        for _, fname in ipairs(fs.list(drive.fullPath)) do
            local fpath = drive.fullPath .. "/" .. fname
            if not fs.isDir(fpath) then
                table.insert(files, {
                    name = fname,
                    size = fs.getSize(fpath),
                    drive = driveIndex,
                    path = fpath
                })
            end
        end
    end
    
    return files
end

function JBOD:findFile(filename)
    for i = 1, #self.drives do
        local files = self:getDriveFiles(i)
        for _, f in ipairs(files) do
            if f.name == filename then return f end
        end
    end
    return nil
end

function JBOD:readFile(filename)
    local file = self:findFile(filename)
    if not file then return nil end
    
    local h = fs.open(file.path, "r")
    if not h then return nil end
    local data = h.readAll()
    h.close()
    return data
end

function JBOD:writeFile(filename, data)
    local bestDrive = nil
    local bestFree = -1
    
    for i, drive in ipairs(self.drives) do
        local free = 0
        if drive.isRaid and drive.peripheral.getDisk then
            for slot = 1, 9 do
                local ok, disk = pcall(function() return drive.peripheral.getDisk(slot) end)
                if ok and disk and disk.getMountPath then
                    local ok2, mp = pcall(function() return disk.getMountPath() end)
                    if ok2 and mp then
                        free = free + fs.getFreeSpace("/" .. mp)
                    end
                end
            end
        elseif drive.fullPath then
            free = fs.getFreeSpace(drive.fullPath)
        end
        
        if free > bestFree then
            bestFree = free
            bestDrive = i
        end
    end
    
    if not bestDrive or bestFree < #data then return false, "Not enough space" end
    
    local drive = self.drives[bestDrive]
    
    if drive.isRaid and drive.peripheral.getDisk then
        for slot = 1, 9 do
            local ok, disk = pcall(function() return drive.peripheral.getDisk(slot) end)
            if ok and disk and disk.getMountPath then
                local ok2, mp = pcall(function() return disk.getMountPath() end)
                if ok2 and mp then
                    local path = "/" .. mp .. "/" .. filename
                    local h = fs.open(path, "w")
                    if h then
                        h.write(data)
                        h.close()
                        return true
                    end
                end
            end
        end
    else
        local path = drive.fullPath .. "/" .. filename
        local h = fs.open(path, "w")
        if h then
            h.write(data)
            h.close()
            return true
        end
    end
    
    return false, "Write failed"
end

function JBOD:deleteFile(filename)
    local file = self:findFile(filename)
    if not file then return false end
    fs.delete(file.path)
    return true
end

function JBOD:listAllFiles()
    local all = {}
    for i = 1, #self.drives do
        local files = self:getDriveFiles(i)
        for _, f in ipairs(files) do
            table.insert(all, f.name)
        end
    end
    return all
end

-- ============================================
-- STATS
-- ============================================

function JBOD:getStats()
    local total, used, free = 0, 0, 0
    
    for i = 1, #self.drives do
        local drive = self.drives[i]
        
        if drive.isRaid and drive.peripheral.getDisk then
            for slot = 1, 9 do
                local ok, disk = pcall(function() return drive.peripheral.getDisk(slot) end)
                if ok and disk and disk.getMountPath then
                    local ok2, mp = pcall(function() return disk.getMountPath() end)
                    if ok2 and mp then
                        local path = "/" .. mp
                        local cap = 2000000 -- Default 2MB
                        if fs.getCapacity then
                            local ok3, c = pcall(function() return fs.getCapacity(path) end)
                            if ok3 then cap = c end
                        end
                        total = total + cap
                        free = free + fs.getFreeSpace(path)
                    end
                end
            end
        elseif drive.fullPath then
            local cap = 2000000
            if fs.getCapacity then
                local ok, c = pcall(function() return fs.getCapacity(drive.fullPath) end)
                if ok then cap = c end
            end
            total = total + cap
            free = free + fs.getFreeSpace(drive.fullPath)
        end
    end
    
    used = total - free
    
    return {
        total = total,
        used = used,
        free = free,
        percent = total > 0 and math.floor((used / total) * 100) or 0,
        drives = #self.drives
    }
end

-- ============================================
-- NETWORK PROTOCOL
-- ============================================

function JBOD:handleRequest()
    print("NFS Server ready! Computer ID: " .. os.getComputerID())
    print("Waiting for clients...")
    print("Press 'Q' to stop server")
    print()
    
    while self.running do
        local timer = os.startTimer(0.5)
        local event = {os.pullEvent()}
        
        if event[1] == "rednet_message" then
            local id, msg, protocol = event[2], event[3], event[4]
            
            if protocol == "jbod" and msg and msg.action then
                self.clients[id] = os.time()
                
                -- DISCOVERY
                if msg.action == "discover" then
                    rednet.send(id, { 
                        server = true, 
                        version = self.version,
                        id = os.getComputerID()
                    }, "jbod")
                    
                -- LIST FILES
                elseif msg.action == "list" then
                    local files = self:listAllFiles()
                    rednet.send(id, { files = files }, "jbod")
                    
                -- READ FILE
                elseif msg.action == "read" and msg.file then
                    local data = self:readFile(msg.file)
                    rednet.send(id, { 
                        data = data,
                        found = data ~= nil
                    }, "jbod")
                    
                -- WRITE FILE
                elseif msg.action == "write" and msg.file and msg.data then
                    local ok, err = self:writeFile(msg.file, msg.data)
                    rednet.send(id, { success = ok, error = err }, "jbod")
                    
                -- DELETE FILE
                elseif msg.action == "delete" and msg.file then
                    local ok = self:deleteFile(msg.file)
                    rednet.send(id, { success = ok }, "jbod")
                    
                -- STATS
                elseif msg.action == "stats" then
                    local stats = self:getStats()
                    rednet.send(id, { stats = stats }, "jbod")
                    
                -- EXECUTE FILE
                elseif msg.action == "execute" and msg.file then
                    local data = self:readFile(msg.file)
                    if data then
                        rednet.send(id, { 
                            success = true,
                            code = data
                        }, "jbod")
                    else
                        rednet.send(id, { 
                            success = false,
                            error = "File not found"
                        }, "jbod")
                    end
                end
            end
            
        elseif event[1] == "timer" and event[2] == timer then
            -- Just the check timer, continue
            
        elseif event[1] == "key" then
            if event[2] == keys.q then
                print("Stopping server...")
                self.running = false
            end
        end
    end
end

-- ============================================
-- MAIN
-- ============================================

function main()
    term.clear()
    term.setCursorPos(1,1)
    
    print("===================================================")
    print("  KIRITO SOFTWORKS JBOD NFS SERVER v" .. JBOD.version)
    print("  Network File System - Remote Execution Enabled")
    print("===================================================")
    print()
    
    if not JBOD:openModem() then
        print("ERROR: No modem found!")
        print("Place a wireless modem on any side")
        return
    end
    
    JBOD:scanDrives()
    
    if #JBOD.drives == 0 then
        print()
        print("WARNING: No drives found!")
        print("Insert disks and press any key to retry...")
        os.pullEvent("key")
        JBOD:scanDrives()
    end
    
    print()
    JBOD:handleRequest()
    
    print("Server stopped")
end

main()
