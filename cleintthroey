-- ============================================
-- KIRITO SOFTWORKS JBOD CLIENT v4.1
-- Auto-detects modem - no more "back" errors!
-- ============================================

local SERVER_ID = nil
local MODEM_SIDE = nil

-- ============================================
-- MODEM AUTO-DETECTION
-- ============================================

function findAndOpenModem()
    -- Check all possible sides for a modem
    local sides = {"top", "bottom", "left", "right", "front", "back"}
    
    for _, side in ipairs(sides) do
        if peripheral.getType(side) == "modem" then
            -- Found a modem!
            MODEM_SIDE = side
            rednet.open(side)
            print("Opened modem on " .. side)
            return true
        end
    end
    
    -- Check for wired modems on network
    local names = peripheral.getNames()
    for _, name in ipairs(names) do
        if peripheral.getType(name) == "modem" then
            MODEM_SIDE = name
            rednet.open(name)
            print("Opened modem: " .. name)
            return true
        end
    end
    
    return false
end

-- ============================================
-- SERVER CONNECTION
-- ============================================

function findServer()
    print("Searching for JBOD server...")
    
    if not findAndOpenModem() then
        print("ERROR: No modem found!")
        print("Place a wireless modem on any side of the computer")
        return false
    end
    
    -- Broadcast discovery
    rednet.broadcast({ action = "discover" }, "jbod")
    
    -- Wait for response
    local timer = os.startTimer(3)
    while true do
        local event, id, msg, protocol = os.pullEvent()
        if event == "rednet_message" and protocol == "jbod" and msg and msg.server then
            print("Found server at computer " .. id)
            SERVER_ID = id
            return true
        elseif event == "timer" and id == timer then
            print("No server found!")
            print("Make sure server is running and in range")
            return false
        end
    end
end

function connect(serverId)
    if not findAndOpenModem() then
        return false
    end
    SERVER_ID = serverId
    print("Connected to JBOD server " .. serverId)
    return true
end

-- ============================================
-- JBOD OPERATIONS
-- ============================================

function listFiles()
    if not SERVER_ID then
        print("Not connected!")
        return nil
    end
    
    rednet.send(SERVER_ID, { action = "list" }, "jbod")
    
    local timer = os.startTimer(5)
    while true do
        local event, id, msg = os.pullEvent()
        if event == "rednet_message" and id == SERVER_ID then
            return msg.files or {}
        elseif event == "timer" and id == timer then
            print("Request timed out")
            return nil
        end
    end
end

function download(filename, localName)
    if not SERVER_ID then
        print("Not connected!")
        return false
    end
    
    rednet.send(SERVER_ID, { action = "read", file = filename }, "jbod")
    
    local timer = os.startTimer(5)
    while true do
        local event, id, msg = os.pullEvent()
        if event == "rednet_message" and id == SERVER_ID then
            if msg.data then
                local h = fs.open(localName or filename, "w")
                if h then
                    h.write(msg.data)
                    h.close()
                    print("Downloaded: " .. filename)
                    return true
                end
            else
                print("File not found on server")
                return false
            end
        elseif event == "timer" and id == timer then
            print("Download timed out")
            return false
        end
    end
end

function upload(localFile, remoteName)
    if not SERVER_ID then
        print("Not connected!")
        return false
    end
    
    if not fs.exists(localFile) or fs.isDir(localFile) then
        print("Local file not found: " .. localFile)
        return false
    end
    
    local h = fs.open(localFile, "r")
    local data = h.readAll()
    h.close()
    
    rednet.send(SERVER_ID, { 
        action = "write", 
        file = remoteName or fs.getName(localFile),
        data = data 
    }, "jbod")
    
    local timer = os.startTimer(5)
    while true do
        local event, id, msg = os.pullEvent()
        if event == "rednet_message" and id == SERVER_ID then
            if msg.success then
                print("Uploaded successfully")
                return true
            else
                print("Upload failed: " .. tostring(msg.error))
                return false
            end
        elseif event == "timer" and id == timer then
            print("Upload timed out")
            return false
        end
    end
end

function getStats()
    if not SERVER_ID then return nil end
    
    rednet.send(SERVER_ID, { action = "stats" }, "jbod")
    
    local timer = os.startTimer(3)
    while true do
        local event, id, msg = os.pullEvent()
        if event == "rednet_message" and id == SERVER_ID then
            return msg.stats
        elseif event == "timer" and id == timer then
            return nil
        end
    end
end

-- ============================================
-- MOUNT VIRTUAL DIRECTORY
-- ============================================

function mount(mountPoint)
    mountPoint = mountPoint or "/remote_pool"
    
    if not SERVER_ID then
        print("Not connected!")
        return false
    end
    
    -- Create mount directory
    if not fs.exists(mountPoint) then
        fs.makeDir(mountPoint)
    end
    
    print("Downloading all files to " .. mountPoint .. "...")
    
    local files = listFiles()
    if not files then return false end
    
    local count = 0
    for _, fname in ipairs(files) do
        if download(fname, mountPoint .. "/" .. fname) then
            count = count + 1
        end
    end
    
    print("Mounted " .. count .. " files to " .. mountPoint)
    print("Files are now available locally!")
    return true
end

-- ============================================
-- INTERACTIVE SHELL
-- ============================================

function interactive()
    term.clear()
    term.setCursorPos(1,1)
    
    print("===================================================")
    print("     KIRITO SOFTWORKS JBOD CLIENT")
    print("===================================================")
    print()
    
    -- Connection setup
    print("Connection options:")
    print("1. Auto-discover server")
    print("2. Enter server ID manually")
    write("Choice (1-2): ")
    local choice = read()
    
    if choice == "1" then
        if not findServer() then
            print()
            print("Press Enter to exit...")
            read()
            return
        end
    else
        write("Enter server computer ID: ")
        local id = tonumber(read())
        if not id then
            print("Invalid ID!")
            return
        end
        if not connect(id) then
            print()
            print("Press Enter to exit...")
            read()
            return
        end
    end
    
    -- Main loop
    print()
    print("Commands:")
    print("  list, ls  - List all files")
    print("  get <file> [saveas]  - Download file")
    print("  put <file> [saveas]  - Upload file")
    print("  mount [path]  - Mount to local folder")
    print("  stats  - Show server storage")
    print("  quit, q  - Exit")
    print()
    
    while true do
        write("jbod> ")
        local input = read()
        local args = {}
        for word in input:gmatch("%S+") do table.insert(args, word) end
        
        local cmd = args[1] or ""
        
        if cmd == "quit" or cmd == "q" then
            print("Goodbye!")
            break
            
        elseif cmd == "list" or cmd == "ls" then
            local files = listFiles()
            if files then
                print("Files on server:")
                for _, f in ipairs(files) do
                    print("  " .. f)
                end
                print("Total: " .. #files .. " files")
            end
            
        elseif cmd == "get" and args[2] then
            local saveAs = args[3] or args[2]
            download(args[2], saveAs)
            
        elseif cmd == "put" and args[2] then
            local remoteName = args[3] or fs.getName(args[2])
            upload(args[2], remoteName)
            
        elseif cmd == "mount" then
            mount(args[2] or "/remote_pool")
            
        elseif cmd == "stats" then
            local s = getStats()
            if s then
                print("Server storage:")
                print("  Drives: " .. s.drives)
                print("  Used: " .. s.used .. " bytes")
                print("  Free: " .. s.free .. " bytes")
                print("  Total: " .. s.total .. " bytes")
            end
            
        elseif cmd ~= "" then
            print("Unknown command: " .. cmd)
        end
    end
end

-- ============================================
-- API EXPORT
-- ============================================

function exportAPI()
    _G.JBOD_CLIENT = {
        connect = function(id) return connect(id) end,
        list = listFiles,
        read = function(fname) 
            rednet.send(SERVER_ID, { action = "read", file = fname }, "jbod")
            local _, _, msg = os.pullEvent("rednet_message")
            return msg and msg.data
        end,
        write = upload,
        stats = getStats,
        mount = mount
    }
    print("JBOD_CLIENT API ready")
end

-- ============================================
-- MAIN
-- ============================================

local args = {...}
if args[1] == "api" then
    if connect(tonumber(args[2])) then
        exportAPI()
    end
else
    interactive()
end
